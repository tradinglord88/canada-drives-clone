<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Driver App - Green Light Automotive</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f5f5f5;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        .driver-app {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background: #0a5c3e;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .app-header h1 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .driver-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .driver-avatar {
            width: 35px;
            height: 35px;
            background: white;
            color: #0a5c3e;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .login-screen {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-form {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .login-form h2 {
            margin-bottom: 20px;
            color: #0a5c3e;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #0a5c3e;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #0a5c3e;
            color: white;
        }

        .btn-primary:hover {
            background: #083d2a;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(10, 92, 62, 0.3);
        }

        .main-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #driverMap {
            flex: 1;
            width: 100%;
        }

        .delivery-info-panel {
            background: white;
            padding: 20px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            max-height: 40%;
            overflow-y: auto;
        }

        .delivery-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .delivery-card:hover {
            border-color: #0a5c3e;
            transform: translateY(-2px);
        }

        .delivery-card.active {
            border-color: #0a5c3e;
            background: #e8f5e9;
        }

        .delivery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .delivery-id {
            font-weight: 600;
            color: #0a5c3e;
        }

        .delivery-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-assigned {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-picked_up {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-in_transit {
            background: #e8f5e9;
            color: #388e3c;
        }

        .delivery-details {
            font-size: 0.9rem;
            color: #666;
        }

        .delivery-details i {
            width: 20px;
            color: #999;
        }

        .action-buttons {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .btn-action {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-start {
            background: #4caf50;
            color: white;
        }

        .btn-navigate {
            background: #2196f3;
            color: white;
        }

        .btn-complete {
            background: #ff9800;
            color: white;
        }

        .btn-action:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tracking-status {
            position: fixed;
            top: 70px;
            left: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }

        .tracking-status.active {
            display: block;
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .status-info {
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .status-item {
            flex: 1;
        }

        .status-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0a5c3e;
        }

        .status-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }

        .completion-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .completion-modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .signature-pad {
            border: 2px dashed #ddd;
            border-radius: 10px;
            height: 200px;
            position: relative;
            margin-bottom: 20px;
            background: #fafafa;
        }

        canvas {
            border-radius: 8px;
        }

        .signature-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #999;
            pointer-events: none;
        }

        .photo-upload {
            margin-bottom: 20px;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #0a5c3e;
            background: #f8f9fa;
        }

        .upload-area i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 10px;
        }

        .notes-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .delivery-info-panel {
                max-height: 50%;
            }
        }
    </style>
</head>
<body>
    <div class="driver-app">
        <!-- App Header -->
        <div class="app-header">
            <h1><i class="fas fa-truck"></i> Driver App</h1>
            <div class="driver-info hidden" id="driverInfo">
                <span id="driverName">Driver</span>
                <div class="driver-avatar" id="driverAvatar">D</div>
            </div>
        </div>

        <!-- Login Screen -->
        <div class="login-screen" id="loginScreen">
            <form class="login-form" onsubmit="handleLogin(event)">
                <h2>Driver Login</h2>
                <div class="form-group">
                    <label for="driverId">Driver ID</label>
                    <input type="text" id="driverId" placeholder="Enter your driver ID" required>
                </div>
                <div class="form-group">
                    <label for="driverPin">PIN</label>
                    <input type="password" id="driverPin" placeholder="Enter your PIN" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                <p style="text-align: center; margin-top: 20px; color: #666; font-size: 0.9rem;">
                    Demo: Use any ID with PIN: 1234
                </p>
            </form>
        </div>

        <!-- Main Screen -->
        <div class="main-screen hidden" id="mainScreen">
            <!-- Map -->
            <div id="driverMap"></div>

            <!-- Tracking Status Panel -->
            <div class="tracking-status" id="trackingStatus">
                <div class="status-header">
                    <h3>Live Tracking</h3>
                    <span id="currentTime">--:--</span>
                </div>
                <div class="status-info">
                    <div class="status-item">
                        <div class="status-value" id="speedValue">0</div>
                        <div class="status-label">km/h</div>
                    </div>
                    <div class="status-item">
                        <div class="status-value" id="distanceValue">0</div>
                        <div class="status-label">km remaining</div>
                    </div>
                    <div class="status-item">
                        <div class="status-value" id="etaValue">--</div>
                        <div class="status-label">min ETA</div>
                    </div>
                </div>
            </div>

            <!-- Delivery Info Panel -->
            <div class="delivery-info-panel">
                <h3>Active Deliveries</h3>
                <div id="deliveryList">
                    <!-- Delivery cards will be loaded here -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons" id="actionButtons">
                <button class="btn-action btn-start" id="btnStart" onclick="startDelivery()">
                    <i class="fas fa-play"></i> Start Delivery
                </button>
                <button class="btn-action btn-navigate" id="btnNavigate" onclick="openNavigation()" disabled>
                    <i class="fas fa-route"></i> Navigate
                </button>
                <button class="btn-action btn-complete" id="btnComplete" onclick="showCompletionModal()" disabled>
                    <i class="fas fa-check-circle"></i> Complete
                </button>
            </div>
        </div>

        <!-- Completion Modal -->
        <div class="completion-modal" id="completionModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Complete Delivery</h2>
                    <button class="modal-close" onclick="hideCompletionModal()">&times;</button>
                </div>

                <div class="form-group">
                    <label>Customer Signature</label>
                    <div class="signature-pad" id="signaturePad">
                        <canvas id="signatureCanvas"></canvas>
                        <div class="signature-label">Sign here</div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="clearSignature()">
                        <i class="fas fa-eraser"></i> Clear Signature
                    </button>
                </div>

                <div class="form-group photo-upload">
                    <label>Delivery Photo (Optional)</label>
                    <div class="upload-area" onclick="document.getElementById('deliveryPhoto').click()">
                        <i class="fas fa-camera"></i>
                        <p>Take or Upload Photo</p>
                        <input type="file" id="deliveryPhoto" accept="image/*" style="display: none;" onchange="previewPhoto(event)">
                    </div>
                    <img id="photoPreview" style="max-width: 100%; margin-top: 10px; display: none;">
                </div>

                <div class="form-group">
                    <label for="deliveryNotes">Delivery Notes (Optional)</label>
                    <textarea id="deliveryNotes" class="notes-textarea" placeholder="Any special instructions or notes about the delivery..."></textarea>
                </div>

                <button class="btn btn-primary" onclick="completeDelivery()">
                    <i class="fas fa-check"></i> Confirm Delivery
                </button>
            </div>
        </div>
    </div>

    <!-- Socket.io -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- Google Maps -->
    <script>
        let driverMap;
        let driverMarker;
        let destinationMarker;
        let routePath;
        let socket;
        let currentDelivery = null;
        let driverToken = null;
        let driverId = null;
        let watchId = null;
        let signatureCanvas;
        let signatureCtx;

        // Initialize
        function init() {
            // Check if already logged in
            driverToken = localStorage.getItem('driverToken');
            driverId = localStorage.getItem('driverId');
            
            if (driverToken && driverId) {
                showMainScreen();
            }

            // Initialize signature canvas
            signatureCanvas = document.getElementById('signatureCanvas');
            signatureCtx = signatureCanvas.getContext('2d');
            setupSignaturePad();
        }

        // Login handler
        async function handleLogin(event) {
            event.preventDefault();
            const id = document.getElementById('driverId').value;
            const pin = document.getElementById('driverPin').value;

            try {
                const response = await fetch('/api/driver/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ driverId: id, pin })
                });

                const data = await response.json();
                
                if (data.success) {
                    driverToken = data.token;
                    driverId = id;
                    localStorage.setItem('driverToken', driverToken);
                    localStorage.setItem('driverId', driverId);
                    showMainScreen();
                } else {
                    alert('Invalid credentials');
                }
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        }

        // Show main screen
        function showMainScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            document.getElementById('driverInfo').classList.remove('hidden');
            document.getElementById('driverName').textContent = `Driver ${driverId}`;
            document.getElementById('driverAvatar').textContent = driverId.charAt(0).toUpperCase();

            // Initialize socket connection
            connectSocket();
            
            // Load deliveries
            loadDeliveries();
            
            // Update time
            setInterval(updateTime, 1000);
        }

        // Connect to WebSocket
        function connectSocket() {
            socket = io('/tracking');
            
            socket.on('connect', () => {
                console.log('Connected to tracking server');
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from tracking server');
            });
        }

        // Load driver's deliveries
        async function loadDeliveries() {
            try {
                // For demo, create sample deliveries
                const deliveries = [
                    {
                        tracking_id: 'GLA-2024-1234',
                        order_number: 'ORD-001234',
                        vehicle_info: '2023 Toyota Camry SE',
                        customer_name: 'John Doe',
                        delivery_address: '123 Main St, Ottawa, ON',
                        status: 'assigned',
                        destination_lat: 45.3876,
                        destination_lng: -75.6960
                    }
                ];

                displayDeliveries(deliveries);
            } catch (error) {
                console.error('Failed to load deliveries:', error);
            }
        }

        // Display deliveries
        function displayDeliveries(deliveries) {
            const list = document.getElementById('deliveryList');
            list.innerHTML = deliveries.map(delivery => `
                <div class="delivery-card ${currentDelivery?.tracking_id === delivery.tracking_id ? 'active' : ''}" 
                     onclick="selectDelivery('${delivery.tracking_id}', ${delivery.destination_lat}, ${delivery.destination_lng})">
                    <div class="delivery-header">
                        <span class="delivery-id">${delivery.tracking_id}</span>
                        <span class="delivery-status status-${delivery.status}">${delivery.status.replace('_', ' ')}</span>
                    </div>
                    <div class="delivery-details">
                        <p><i class="fas fa-car"></i> ${delivery.vehicle_info}</p>
                        <p><i class="fas fa-user"></i> ${delivery.customer_name}</p>
                        <p><i class="fas fa-map-marker-alt"></i> ${delivery.delivery_address}</p>
                    </div>
                </div>
            `).join('');

            // Auto-select first delivery
            if (deliveries.length > 0 && !currentDelivery) {
                selectDelivery(deliveries[0].tracking_id, deliveries[0].destination_lat, deliveries[0].destination_lng);
            }
        }

        // Select delivery
        function selectDelivery(trackingId, destLat, destLng) {
            currentDelivery = { 
                tracking_id: trackingId,
                destination: { lat: destLat, lng: destLng }
            };
            
            // Update UI
            document.querySelectorAll('.delivery-card').forEach(card => {
                card.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Update map destination
            if (driverMap && destinationMarker) {
                destinationMarker.setPosition(currentDelivery.destination);
                driverMap.panTo(currentDelivery.destination);
            }
        }

        // Initialize map
        function initDriverMap() {
            // Default to Ottawa
            const defaultLocation = { lat: 45.4215, lng: -75.6972 };
            
            driverMap = new google.maps.Map(document.getElementById('driverMap'), {
                zoom: 13,
                center: defaultLocation,
                mapTypeControl: false,
                fullscreenControl: false,
                streetViewControl: false
            });

            // Driver marker
            driverMarker = new google.maps.Marker({
                position: defaultLocation,
                map: driverMap,
                title: 'Your Location',
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="20" cy="20" r="18" fill="#0a5c3e" stroke="white" stroke-width="2"/>
                            <circle cx="20" cy="20" r="8" fill="white"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(40, 40),
                    anchor: new google.maps.Point(20, 20)
                }
            });

            // Destination marker
            destinationMarker = new google.maps.Marker({
                position: defaultLocation,
                map: driverMap,
                title: 'Destination',
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="20" cy="20" r="18" fill="#dc3545" stroke="white" stroke-width="2"/>
                            <path d="M20 10 L26 16 L26 24 L20 30 L14 24 L14 16 Z" fill="white"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(40, 40),
                    anchor: new google.maps.Point(20, 20)
                }
            });

            // Start tracking location
            startLocationTracking();
        }

        // Start location tracking
        function startLocationTracking() {
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const location = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Update driver marker
                        if (driverMarker) {
                            driverMarker.setPosition(location);
                            
                            // Center map on first update
                            if (!driverMap.getBounds()?.contains(location)) {
                                driverMap.panTo(location);
                            }
                        }

                        // If tracking active, emit location update
                        if (currentDelivery && document.getElementById('trackingStatus').classList.contains('active')) {
                            socket.emit('driver-location-update', {
                                trackingId: currentDelivery.tracking_id,
                                location,
                                speed: position.coords.speed,
                                heading: position.coords.heading
                            });

                            // Update UI
                            updateTrackingUI(position);
                        }
                    },
                    (error) => {
                        console.error('Location error:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }
        }

        // Start delivery
        function startDelivery() {
            if (!currentDelivery) {
                alert('Please select a delivery first');
                return;
            }

            // Get current location
            navigator.geolocation.getCurrentPosition((position) => {
                const location = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                // Emit start event
                socket.emit('driver-start-delivery', {
                    trackingId: currentDelivery.tracking_id,
                    driverId: driverId,
                    driverLocation: location
                });

                // Update UI
                document.getElementById('btnStart').disabled = true;
                document.getElementById('btnNavigate').disabled = false;
                document.getElementById('btnComplete').disabled = false;
                document.getElementById('trackingStatus').classList.add('active');

                // Join tracking room
                socket.emit('track-delivery', currentDelivery.tracking_id);
            });
        }

        // Open navigation
        function openNavigation() {
            if (!currentDelivery) return;
            
            const dest = currentDelivery.destination;
            const url = `https://www.google.com/maps/dir/?api=1&destination=${dest.lat},${dest.lng}`;
            window.open(url, '_blank');
        }

        // Update tracking UI
        function updateTrackingUI(position) {
            // Update speed
            const speed = position.coords.speed || 0;
            document.getElementById('speedValue').textContent = Math.round(speed * 3.6); // m/s to km/h

            // Calculate distance (simplified)
            if (currentDelivery?.destination) {
                const distance = calculateDistance(
                    position.coords.latitude,
                    position.coords.longitude,
                    currentDelivery.destination.lat,
                    currentDelivery.destination.lng
                );
                document.getElementById('distanceValue').textContent = distance.toFixed(1);
                
                // Estimate time (assuming average 50 km/h)
                const eta = Math.round((distance / 50) * 60);
                document.getElementById('etaValue').textContent = eta;
            }
        }

        // Calculate distance between two points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Update time
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 
                now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        // Setup signature pad
        function setupSignaturePad() {
            signatureCanvas.width = signatureCanvas.offsetWidth;
            signatureCanvas.height = signatureCanvas.offsetHeight;
            
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('mouseup', stopDrawing);
            signatureCanvas.addEventListener('mouseout', stopDrawing);

            // Touch events
            signatureCanvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = signatureCanvas.getBoundingClientRect();
                startDrawing({
                    offsetX: touch.clientX - rect.left,
                    offsetY: touch.clientY - rect.top
                });
            });

            signatureCanvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = signatureCanvas.getBoundingClientRect();
                draw({
                    offsetX: touch.clientX - rect.left,
                    offsetY: touch.clientY - rect.top
                });
            });

            signatureCanvas.addEventListener('touchend', stopDrawing);

            function startDrawing(e) {
                isDrawing = true;
                [lastX, lastY] = [e.offsetX, e.offsetY];
                document.querySelector('.signature-label').style.display = 'none';
            }

            function draw(e) {
                if (!isDrawing) return;
                
                signatureCtx.beginPath();
                signatureCtx.moveTo(lastX, lastY);
                signatureCtx.lineTo(e.offsetX, e.offsetY);
                signatureCtx.strokeStyle = '#000';
                signatureCtx.lineWidth = 2;
                signatureCtx.lineCap = 'round';
                signatureCtx.stroke();
                
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }

            function stopDrawing() {
                isDrawing = false;
            }
        }

        // Clear signature
        function clearSignature() {
            signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            document.querySelector('.signature-label').style.display = 'block';
        }

        // Show completion modal
        function showCompletionModal() {
            document.getElementById('completionModal').classList.add('active');
        }

        // Hide completion modal
        function hideCompletionModal() {
            document.getElementById('completionModal').classList.remove('active');
        }

        // Preview photo
        function previewPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('photoPreview').src = e.target.result;
                    document.getElementById('photoPreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        // Complete delivery
        function completeDelivery() {
            if (!currentDelivery) return;

            // Get signature data
            const signatureData = signatureCanvas.toDataURL();
            const notes = document.getElementById('deliveryNotes').value;
            
            // Emit completion event
            socket.emit('driver-complete-delivery', {
                trackingId: currentDelivery.tracking_id,
                signature: signatureData,
                notes: notes,
                photoUrl: document.getElementById('photoPreview').src || null
            });

            // Reset UI
            hideCompletionModal();
            alert('Delivery completed successfully!');
            
            // Reset buttons
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnNavigate').disabled = true;
            document.getElementById('btnComplete').disabled = true;
            document.getElementById('trackingStatus').classList.remove('active');
            
            // Clear current delivery
            currentDelivery = null;
            
            // Reload deliveries
            loadDeliveries();
        }

        // Initialize on load
        window.addEventListener('load', init);
    </script>

    <!-- Google Maps API -->
    <script>
        // Handle authentication failures
        window.gm_authFailure = function() {
            console.error('Google Maps authentication failed. Please check your API key and ensure the Maps JavaScript API is enabled.');
            alert('Google Maps authentication failed. Please ensure the Maps JavaScript API is enabled in your Google Cloud Console.');
        };
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBEBdu5vOONDHNbAu0Hxv9Ko5BQRd20C_Y&libraries=maps,marker&v=weekly&callback=initDriverMap"></script>
</body>
</html>