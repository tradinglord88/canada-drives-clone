<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Management - Green Light Automotive</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }

        .admin-header {
            background-color: #0a5c3e;
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .controls {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #0a5c3e;
            color: white;
        }

        .btn-primary:hover {
            background: #083d2a;
        }

        .deliveries-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .delivery-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
            position: relative;
            transition: transform 0.3s ease;
        }

        .delivery-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .delivery-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .delivery-id {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0a5c3e;
        }

        .delivery-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-pending {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-assigned {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .status-picked_up {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-in_transit {
            background: #e8f5e9;
            color: #388e3c;
        }

        .status-delivered {
            background: #e0f2f1;
            color: #00796b;
        }

        .delivery-info {
            margin-bottom: 1rem;
        }

        .info-row {
            display: flex;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .info-label {
            width: 120px;
            color: #666;
            font-weight: 500;
        }

        .info-value {
            flex: 1;
            color: #333;
        }

        .delivery-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .btn-track {
            background: #2196f3;
            color: white;
        }

        .btn-assign {
            background: #ff9800;
            color: white;
        }

        .btn-edit {
            background: #4caf50;
            color: white;
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .live-map {
            height: 400px;
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .tracking-link {
            background: #e3f2fd;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        .tracking-link input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-family: monospace;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .deliveries-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="admin-header">
        <h1><i class="fas fa-truck"></i> Delivery Management</h1>
        <div>
            <a href="/admin" class="btn btn-primary">Back to Admin</a>
        </div>
    </header>

    <div class="container">
        <div class="controls">
            <h2>Active Deliveries</h2>
            <button class="btn btn-primary" onclick="showCreateModal()">
                <i class="fas fa-plus"></i> Create New Delivery
            </button>
        </div>

        <div class="deliveries-grid" id="deliveriesGrid">
            <!-- Delivery cards will be loaded here -->
        </div>
    </div>

    <!-- Create/Edit Delivery Modal -->
    <div class="modal" id="deliveryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Create New Delivery</h2>
                <button class="modal-close" onclick="hideModal()">&times;</button>
            </div>
            
            <form id="deliveryForm" onsubmit="saveDelivery(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Order Number*</label>
                        <input type="text" name="order_number" required placeholder="ORD-XXXXXX">
                    </div>
                    <div class="form-group">
                        <label>Vehicle Info*</label>
                        <input type="text" name="vehicle_info" required placeholder="2023 Toyota Camry SE">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Customer Name*</label>
                        <input type="text" name="customer_name" required>
                    </div>
                    <div class="form-group">
                        <label>Customer Phone*</label>
                        <input type="tel" name="customer_phone" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Customer Email</label>
                    <input type="email" name="customer_email">
                </div>

                <div class="form-group">
                    <label>Pickup Location*</label>
                    <input type="text" name="pickup_location" required placeholder="Toronto, ON">
                </div>

                <div class="form-group">
                    <label>Delivery Address*</label>
                    <textarea name="delivery_address" required placeholder="123 Main St, Ottawa, ON K1A 0B1"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Driver Name*</label>
                        <input type="text" name="driver_name" required>
                    </div>
                    <div class="form-group">
                        <label>Driver Phone*</label>
                        <input type="tel" name="driver_phone" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Destination Latitude*</label>
                        <input type="number" name="destination_lat" step="any" required>
                    </div>
                    <div class="form-group">
                        <label>Destination Longitude*</label>
                        <input type="number" name="destination_lng" step="any" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Estimated Delivery</label>
                    <input type="text" name="estimated_delivery" placeholder="Today, 3:00 PM - 5:00 PM">
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-save"></i> Save Delivery
                </button>
            </form>
        </div>
    </div>

    <!-- Track Delivery Modal -->
    <div class="modal" id="trackModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Live Tracking</h2>
                <button class="modal-close" onclick="hideTrackModal()">&times;</button>
            </div>
            
            <div class="tracking-link">
                <label>Customer Tracking Link:</label>
                <input type="text" id="trackingLink" readonly onclick="this.select()">
                <button class="btn btn-primary btn-small" onclick="copyTrackingLink()" style="margin-top: 10px;">
                    <i class="fas fa-copy"></i> Copy Link
                </button>
            </div>

            <div id="liveMap" class="live-map"></div>
            
            <div id="trackingInfo">
                <!-- Live tracking info will be displayed here -->
            </div>
        </div>
    </div>

    <!-- Socket.io -->
    <script src="/socket.io/socket.io.js"></script>
    
    <script>
        let socket;
        let currentDeliveryId = null;
        let trackingMap;
        let trackingMarker;

        // Initialize
        function init() {
            connectSocket();
            loadDeliveries();
        }

        // Connect to WebSocket
        function connectSocket() {
            socket = io('/tracking');
            
            socket.on('connect', () => {
                console.log('Connected to tracking server');
            });
        }

        // Load deliveries
        async function loadDeliveries() {
            try {
                // For demo, create sample data
                const deliveries = [
                    {
                        id: 1,
                        tracking_id: 'GLA-2024-1234',
                        order_number: 'ORD-001234',
                        vehicle_info: '2023 Toyota Camry SE - Silver',
                        customer_name: 'John Doe',
                        customer_phone: '(555) 123-4567',
                        pickup_location: 'Toronto, ON',
                        delivery_address: '123 Main St, Ottawa, ON',
                        driver_name: 'Mike Johnson',
                        status: 'in_transit',
                        estimated_delivery: 'Today, 3:00 PM - 5:00 PM'
                    },
                    {
                        id: 2,
                        tracking_id: 'GLA-2024-1235',
                        order_number: 'ORD-001235',
                        vehicle_info: '2024 Honda Accord Sport - Black',
                        customer_name: 'Jane Smith',
                        customer_phone: '(555) 234-5678',
                        pickup_location: 'Montreal, QC',
                        delivery_address: '456 King St, Kingston, ON',
                        driver_name: 'Sarah Williams',
                        status: 'assigned',
                        estimated_delivery: 'Tomorrow, 10:00 AM - 12:00 PM'
                    }
                ];

                displayDeliveries(deliveries);
            } catch (error) {
                console.error('Failed to load deliveries:', error);
            }
        }

        // Display deliveries
        function displayDeliveries(deliveries) {
            const grid = document.getElementById('deliveriesGrid');
            grid.innerHTML = deliveries.map(delivery => `
                <div class="delivery-card">
                    <div class="delivery-header">
                        <div class="delivery-id">${delivery.tracking_id}</div>
                        <div class="delivery-status status-${delivery.status}">${delivery.status.replace('_', ' ')}</div>
                    </div>
                    
                    <div class="delivery-info">
                        <div class="info-row">
                            <span class="info-label">Order:</span>
                            <span class="info-value">${delivery.order_number}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Vehicle:</span>
                            <span class="info-value">${delivery.vehicle_info}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Customer:</span>
                            <span class="info-value">${delivery.customer_name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Phone:</span>
                            <span class="info-value">${delivery.customer_phone}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">From:</span>
                            <span class="info-value">${delivery.pickup_location}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">To:</span>
                            <span class="info-value">${delivery.delivery_address}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Driver:</span>
                            <span class="info-value">${delivery.driver_name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ETA:</span>
                            <span class="info-value">${delivery.estimated_delivery}</span>
                        </div>
                    </div>
                    
                    <div class="delivery-actions">
                        <button class="btn btn-small btn-track" onclick="trackDelivery('${delivery.tracking_id}')">
                            <i class="fas fa-map-marker-alt"></i> Track
                        </button>
                        <button class="btn btn-small btn-edit" onclick="editDelivery(${delivery.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-small btn-assign" onclick="assignDriver(${delivery.id})">
                            <i class="fas fa-user"></i> Assign
                        </button>
                        <button class="btn btn-small btn-delete" onclick="deleteDelivery(${delivery.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Show create modal
        function showCreateModal() {
            document.getElementById('modalTitle').textContent = 'Create New Delivery';
            document.getElementById('deliveryForm').reset();
            document.getElementById('deliveryModal').classList.add('active');
        }

        // Hide modal
        function hideModal() {
            document.getElementById('deliveryModal').classList.remove('active');
        }

        // Save delivery
        async function saveDelivery(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            
            // Generate tracking ID
            data.tracking_id = 'GLA-' + new Date().getFullYear() + '-' + Math.floor(Math.random() * 10000);
            data.status = 'pending';
            
            console.log('Saving delivery:', data);
            alert('Delivery created successfully!');
            hideModal();
            loadDeliveries();
        }

        // Track delivery
        function trackDelivery(trackingId) {
            currentDeliveryId = trackingId;
            
            // Show tracking modal
            document.getElementById('trackModal').classList.add('active');
            
            // Set tracking link
            const link = `${window.location.origin}/track-delivery.html#${trackingId}`;
            document.getElementById('trackingLink').value = link;
            
            // Initialize map if needed
            if (!trackingMap) {
                initTrackingMap();
            }
            
            // Join tracking room
            socket.emit('track-delivery', trackingId);
            
            // Listen for updates
            socket.on('location-update', (data) => {
                updateTrackingMap(data.location);
            });
        }

        // Initialize tracking map
        function initTrackingMap() {
            trackingMap = new google.maps.Map(document.getElementById('liveMap'), {
                zoom: 13,
                center: { lat: 45.4215, lng: -75.6972 }
            });
            
            trackingMarker = new google.maps.Marker({
                position: { lat: 45.4215, lng: -75.6972 },
                map: trackingMap,
                title: 'Driver Location',
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="20" cy="20" r="18" fill="#0a5c3e" stroke="white" stroke-width="2"/>
                            <path d="M12 18 L20 14 L28 18 L28 24 L20 28 L12 24 Z" fill="white"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(40, 40),
                    anchor: new google.maps.Point(20, 20)
                }
            });
        }

        // Update tracking map
        function updateTrackingMap(location) {
            if (trackingMarker && trackingMap) {
                const position = new google.maps.LatLng(location.lat, location.lng);
                trackingMarker.setPosition(position);
                trackingMap.panTo(position);
            }
        }

        // Hide track modal
        function hideTrackModal() {
            document.getElementById('trackModal').classList.remove('active');
            if (socket) {
                socket.off('location-update');
            }
        }

        // Copy tracking link
        function copyTrackingLink() {
            const input = document.getElementById('trackingLink');
            input.select();
            document.execCommand('copy');
            alert('Tracking link copied to clipboard!');
        }

        // Edit delivery
        function editDelivery(id) {
            document.getElementById('modalTitle').textContent = 'Edit Delivery';
            // Load delivery data into form
            document.getElementById('deliveryModal').classList.add('active');
        }

        // Assign driver
        function assignDriver(id) {
            const driver = prompt('Enter driver ID:');
            if (driver) {
                alert(`Driver ${driver} assigned to delivery`);
                loadDeliveries();
            }
        }

        // Delete delivery
        function deleteDelivery(id) {
            if (confirm('Are you sure you want to delete this delivery?')) {
                alert('Delivery deleted');
                loadDeliveries();
            }
        }

        // Initialize on load
        window.addEventListener('load', init);
    </script>

    <!-- Google Maps API -->
    <script>
        // Handle authentication failures
        window.gm_authFailure = function() {
            console.error('Google Maps authentication failed. Please check your API key and ensure the Maps JavaScript API is enabled.');
            alert('Google Maps authentication failed. Please ensure the Maps JavaScript API is enabled in your Google Cloud Console.');
        };
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBEBdu5vOONDHNbAu0Hxv9Ko5BQRd20C_Y&libraries=maps,marker&v=weekly"></script>
</body>
</html>