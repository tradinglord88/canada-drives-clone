<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Jobs - Green Light Automotive</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="stylesheet" href="assets/css/mobile.css">
    <link rel="stylesheet" href="assets/css/delivery-bidding.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header class="header">
        <nav class="navbar">
            <div class="container">
                <div class="nav-wrapper">
                    <a href="index.html" class="logo">
                        <h1>Green Light Automotive</h1>
                    </a>
                    <ul class="nav-menu">
                        <li><a href="index.html">Home</a></li>
                        <li><a href="delivery-jobs.html" class="active">Delivery Jobs</a></li>
                        <li><a href="driver-portal.html">Driver Portal</a></li>
                        <li><a href="/admin">Admin</a></li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <main class="delivery-jobs-main">
        <div class="container">
            <div class="page-header">
                <h1><i class="fas fa-truck"></i> Available Delivery Jobs</h1>
                <button class="btn btn-primary" onclick="showPostJobModal()">
                    <i class="fas fa-plus"></i> Post New Job
                </button>
            </div>

            <!-- Filter Section -->
            <div class="filters-section">
                <div class="filter-group">
                    <label>Location:</label>
                    <select id="locationFilter">
                        <option value="">All Locations</option>
                        <option value="Vancouver">Vancouver</option>
                        <option value="Victoria">Victoria</option>
                        <option value="Kelowna">Kelowna</option>
                        <option value="Richmond">Richmond</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Date:</label>
                    <input type="date" id="dateFilter">
                </div>
                <div class="filter-group">
                    <label>Status:</label>
                    <select id="statusFilter">
                        <option value="">All Status</option>
                        <option value="open">Open for Bids</option>
                        <option value="assigned">Assigned</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <button class="btn btn-secondary" onclick="applyFilters()">
                    <i class="fas fa-filter"></i> Apply Filters
                </button>
            </div>

            <!-- Jobs Grid -->
            <div class="jobs-grid" id="jobsGrid">
                <!-- Jobs will be loaded here dynamically -->
            </div>
        </div>
    </main>

    <!-- Post Job Modal -->
    <div class="modal" id="postJobModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Post New Delivery Job</h2>
                <button class="close-btn" onclick="closePostJobModal()">&times;</button>
            </div>
            <form id="postJobForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Customer Name</label>
                        <input type="text" name="customer_name" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-car"></i> Vehicle Info</label>
                        <input type="text" name="vehicle_info" placeholder="Year Make Model - Color" required>
                    </div>
                    <div class="form-group full-width">
                        <label><i class="fas fa-map-marker-alt"></i> Pickup Address</label>
                        <input type="text" name="pickup_address" required>
                    </div>
                    <div class="form-group full-width">
                        <label><i class="fas fa-map-marker-alt"></i> Delivery Address</label>
                        <input type="text" name="delivery_address" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> Delivery Date</label>
                        <input type="date" name="delivery_date" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-clock"></i> Time Window</label>
                        <select name="delivery_window" required>
                            <option value="9:00 AM - 12:00 PM">Morning (9:00 AM - 12:00 PM)</option>
                            <option value="12:00 PM - 3:00 PM">Midday (12:00 PM - 3:00 PM)</option>
                            <option value="3:00 PM - 6:00 PM">Afternoon (3:00 PM - 6:00 PM)</option>
                            <option value="6:00 PM - 9:00 PM">Evening (6:00 PM - 9:00 PM)</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label><i class="fas fa-info-circle"></i> Special Instructions</label>
                        <textarea name="special_instructions" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closePostJobModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Post Job</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Bids Modal -->
    <div class="modal" id="viewBidsModal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2>Bids for Delivery Job</h2>
                <button class="close-btn" onclick="closeViewBidsModal()">&times;</button>
            </div>
            <div class="job-details" id="jobDetailsInModal">
                <!-- Job details will be shown here -->
            </div>
            <div class="bids-list" id="bidsList">
                <!-- Bids will be loaded here -->
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        
        // Load jobs on page load
        document.addEventListener('DOMContentLoaded', loadJobs);

        async function loadJobs() {
            try {
                const response = await fetch('/api/delivery-jobs');
                const jobs = await response.json();
                displayJobs(jobs);
            } catch (error) {
                console.error('Error loading jobs:', error);
            }
        }

        function displayJobs(jobs) {
            const jobsGrid = document.getElementById('jobsGrid');
            
            if (jobs.length === 0) {
                jobsGrid.innerHTML = '<div class="no-jobs">No delivery jobs available at the moment.</div>';
                return;
            }

            jobsGrid.innerHTML = jobs.map(job => `
                <div class="job-card ${job.status}">
                    <div class="job-status-badge ${job.status}">
                        ${job.status.replace('_', ' ').toUpperCase()}
                    </div>
                    <h3>${job.vehicle_info}</h3>
                    <div class="job-info">
                        <p><i class="fas fa-user"></i> ${job.customer_name}</p>
                        <p><i class="fas fa-map-marker-alt"></i> From: ${job.pickup_address}</p>
                        <p><i class="fas fa-map-marker-alt"></i> To: ${job.delivery_address}</p>
                        <p><i class="fas fa-calendar"></i> ${new Date(job.delivery_date).toLocaleDateString()}</p>
                        <p><i class="fas fa-clock"></i> ${job.delivery_window}</p>
                        ${job.distance ? `<p><i class="fas fa-route"></i> ${job.distance} km</p>` : ''}
                    </div>
                    ${job.special_instructions ? `
                        <div class="special-instructions">
                            <i class="fas fa-info-circle"></i> ${job.special_instructions}
                        </div>
                    ` : ''}
                    <div class="job-actions">
                        ${job.status === 'open' ? `
                            <button class="btn btn-primary" onclick="viewBids(${job.id})">
                                <i class="fas fa-gavel"></i> View Bids (${job.bid_count || 0})
                            </button>
                        ` : ''}
                        ${job.status === 'assigned' && job.winning_driver ? `
                            <div class="assigned-driver">
                                <i class="fas fa-user-check"></i> Assigned to ${job.winning_driver}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function showPostJobModal() {
            document.getElementById('postJobModal').style.display = 'flex';
        }

        function closePostJobModal() {
            document.getElementById('postJobModal').style.display = 'none';
            document.getElementById('postJobForm').reset();
        }

        async function viewBids(jobId) {
            try {
                const response = await fetch(`/api/delivery-jobs/${jobId}/bids`);
                const data = await response.json();
                
                // Display job details
                document.getElementById('jobDetailsInModal').innerHTML = `
                    <h3>${data.job.vehicle_info}</h3>
                    <p>${data.job.pickup_address} â†’ ${data.job.delivery_address}</p>
                    <p>${new Date(data.job.delivery_date).toLocaleDateString()} | ${data.job.delivery_window}</p>
                `;
                
                // Display bids
                if (data.bids.length === 0) {
                    document.getElementById('bidsList').innerHTML = '<p class="no-bids">No bids yet for this job.</p>';
                } else {
                    document.getElementById('bidsList').innerHTML = `
                        <h3>Received Bids</h3>
                        <div class="bids-table">
                            ${data.bids.map(bid => `
                                <div class="bid-item ${bid.status}">
                                    <div class="bid-driver">
                                        <strong>${bid.driver_name}</strong>
                                        <div class="driver-rating">
                                            <i class="fas fa-star"></i> ${bid.driver_rating}
                                            <span>(${bid.completed_deliveries} deliveries)</span>
                                        </div>
                                    </div>
                                    <div class="bid-amount">
                                        <strong>$${bid.bid_amount}</strong>
                                        <small>${bid.estimated_completion_time} min</small>
                                    </div>
                                    ${bid.message ? `<div class="bid-message">${bid.message}</div>` : ''}
                                    ${data.job.status === 'open' ? `
                                        <button class="btn btn-success" onclick="acceptBid(${jobId}, ${bid.id})">
                                            Accept Bid
                                        </button>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                document.getElementById('viewBidsModal').style.display = 'flex';
            } catch (error) {
                console.error('Error loading bids:', error);
                alert('Error loading bids');
            }
        }

        function closeViewBidsModal() {
            document.getElementById('viewBidsModal').style.display = 'none';
        }

        async function acceptBid(jobId, bidId) {
            if (!confirm('Are you sure you want to accept this bid?')) return;
            
            try {
                const response = await fetch(`/api/delivery-jobs/${jobId}/accept-bid`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bidId })
                });
                
                if (response.ok) {
                    alert('Bid accepted successfully!');
                    closeViewBidsModal();
                    loadJobs();
                } else {
                    alert('Error accepting bid');
                }
            } catch (error) {
                console.error('Error accepting bid:', error);
                alert('Error accepting bid');
            }
        }

        // Handle job posting
        document.getElementById('postJobForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const jobData = Object.fromEntries(formData);
            
            try {
                const response = await fetch('/api/delivery-jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(jobData)
                });
                
                if (response.ok) {
                    alert('Job posted successfully!');
                    closePostJobModal();
                    loadJobs();
                } else {
                    alert('Error posting job');
                }
            } catch (error) {
                console.error('Error posting job:', error);
                alert('Error posting job');
            }
        });

        // Socket.io for real-time updates
        socket.on('newBid', (data) => {
            console.log('New bid received:', data);
            loadJobs(); // Reload jobs to update bid counts
        });

        socket.on('jobStatusUpdate', (data) => {
            console.log('Job status updated:', data);
            loadJobs();
        });

        // Apply filters
        function applyFilters() {
            const location = document.getElementById('locationFilter').value;
            const date = document.getElementById('dateFilter').value;
            const status = document.getElementById('statusFilter').value;
            
            // Add filter logic here
            console.log('Applying filters:', { location, date, status });
            // You would typically send these to the backend and reload filtered results
        }
    </script>
</body>
</html>